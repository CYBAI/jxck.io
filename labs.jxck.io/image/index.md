# WebP と SVG その他画像最適化戦略

画像の最適化戦略と WebP & SVG

画像は Web におけるコンテンツの中でも非常に支配的なサイズになるため、画像周りの最適化は非常に重要になる。

特に画像の場合は用途に応じて

- フォーマット
- 表示サイズ
- 解像度

などを起点に戦略をたてていく。

# フォーマット

このサイトでは以下を使う

- svg
- png
- jpeg
- gif
- webp

## SVG

アイコンなどのツールチップには  png なども使われるが、このサイトでは基本的に SVG を利用している。

ベクタにすることで、画面サイズや拡大率などに関わらずなめらかな画像を表示することができる。

またソースとなる XML はテキストであるため、 gzip 圧縮による効果もデカイ。

ツールなどで書いた SVG のソースは複雑なパスになり見た目が変わらないにも関わらずサイズが肥大する場合がある。
簡単なもの、このサイトで言えば右上の RSS, AMP のアイコンは最小のものになるよう手書きした。

また、このサイトは見た目が Markdown ライクになるように CSS を作っているが、そこ付与される文字を before/after 擬似要素への content で、文字を指定することでフォントデータを使って装飾している。

これは簡易 font-awesome のような構成であり、マシンローカルのベクタデータを流用しているイメージになる。

## WebP

PNG, JPEG 両方の用途で代替として検討できる。

このフォーマットを使うだけで、画質を犠牲にせずかなりのサイズ削減が期待できる。

WebP アニメーションを使えば GIF アニメよりも色数が多く綺麗なアニメーションを作ることができる。
WebP は WebM の1フレームが基本なため、つまり WebP アニメーションは簡易 WebM と言っても良い。
ちょっとしたスクリーンシェアなどには重宝する。

しかし対応してないブラウザのためには代替として PNG, JPEG などにフォールバックできるように、後述の srcset で選択肢として提示し、ブラウザに選ばせている。

## サイズ戦略

画像において最も無駄なのは、大きいサイズの画像を小さく表示している場合である。
これはネットワークでの転送上も、ブラウザのレンダリング上もオーバーヘッドになる。
サイズが大きいということはデータが多いため、リサイズして表示するサイズぴったりに加工できればデータ量も最適となる。
また、見た目上の劣化が生じなければ、減色などの最適化も考えられるが、ここではまずサイズにフォーカスする。


PC ブラウザを対象にするのであれば、基本的には表示するピクセルサイズにリサイズすれば良い。
問題はモバイルのブラウザの挙動にある。


### メタ情報削除

画像には位置情報やカラープロファイルなどのメタ情報が内包されている場合がある。
これらの情報が不要であれば消してしまうことで、データを削減できる。

そのためのツールはいくつかあるが、有名どころでは以下がある。

- [ImageOptim](https://imageoptim.com)


### 減色

一点の色の情報を 24bit で表しているものを、例えば 8bit に変換することで、表現できる色の数を減らす代わりにデータ量も減らす。
例えばレコードを CD にしたような変化になるが、そもそも Full Bitmap で表現したいという訳でない限り(lossy format 使ってるなら特に)気にならない範囲で行うべきである。

- [TinyPNG](https://tinypng.com/) (JPEG も対応している)
- [ImageAlpha](https://pngmini.com/)
- [JPEGMini](http://www.jpegmini.com/) (有料)
- [pngquant](http://pngquant.org/) (CLI)


### 縮小



## ベースライン/プログレッシブ

JPEG は、大きい画像を送信する際に、ベースとなるデータを先に送り、差分となるデータをあとから追加して画像を完成させることができる。

- ベースライン: 画像を上から順番に表示していく
- プログレッシブ: 解像度の低い画像から表示され、徐々に鮮明になっていく

なお、 PNG はベースラインではなくインタレースと呼ばれる。

どちらを使うかは、二つの観点がある。

- どちらのサイズが小さいか
- UX としてどちらが良いか


### サイズ

まず、前者のサイズについて、少し古いが Steve 先生の調査がある。

http://yuiblog.com/blog/2008/12/05/imageopt-4/

あらゆる画像を二つの形式で保存した場合、サイズがそれぞれどうなるかを検証している。
結果だけ引用する。

> when your JPEG image is under 10K, it's better to be saved as baseline JPEG (estimated 75% chance it will be smaller)
  for files over 10K the progressive JPEG will give you a better compression (in 94% of the cases)

素材のサイズが 10K を超えるかどうかで結果が変わるそうだ。そして必ずではないので、実際に両方で保存してみて試すしかない。


### UX

後者の UX だが、細い回線で大きめの画像を表示した際、ユーザがどう感じるか、という点がある。

まず、個人的には同じサイトでも、サイズによってロードの仕方が変わるのはあまり好ましくないと感じる。

そして、このサイトでは JPEG 以外にも PNG/WebP/SVG を使う。

全ての挙動をなるべく近づけるには、サイズに限らずベースラインに統一するのが良さそうと判断した。

(あと、プログレッシブはなんか古臭いというか、ダサく感じるのは自分だけだろうか)


## 最適イメージの出し分け

サイズ・フォーマット的に最適なイメージは、クライアントによって変わる。
具体的には、現状以下の分岐を考慮する必要がある。

- WebP に対応しているか(ブラウザの分岐)
- ViewPort Size はいくつか(端末サイズの分岐)
- DPI はいくつか(retina 対応)

### WebP 対応

これまでは写真=JPEG, アイコン=PNG, アニメ=GIF といった使い分けがなされていたが、もし対応しているのであれば、これら全て WebP に集約可能であり、その方がサイズ的に有利な場合が多い。

過去の記事では WebP 対応の分岐を、 UA で行う方法などが紹介されていたが、その方法はなかなかスケールしにくい。

一方、 HTML の `<picture>` や `srcset` を用いることで、ブラウザ自体にそれを判断させることができるため、こちらの方法が望ましいと考える。
(これらに対応していない古いブラウザは、そもそも WebP に対応していないという判断)

画像の指定を以下のように指定することで、対応ブラウザが自ら WebP をリクエストするようになり、 WebP や `<picture>` に対応していない場合は `<img>` に指定した画像にフォールバックする。


<picture>
  <source type=image/webp srcset=hero-image.webp>
  <img src=hero-image.png alt="hero image">
</picture>


### サイズ最適化

小さいデバイスが小さく画像を表示する上で、大きいサイズの画像を送信する必要はなくなる。

DPI が高い Retina などでは、画像がが小さく

