<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="amphtml" href="entries/2016-01-28/html-compression.amp.html">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HTML の省略によるサイズ最適化 | blog.jxck.io</title>

  <link rel="stylesheet" type="text/css" href="/assets/style.css">
</head>
<body>
<header>
  <a class="logo" href="/">blog.jxck.io</a>
</header>
<article>
  <div><time datetime="2016-01-28">2016-01-28</time><span class="tags"><a href="/tags/html">html</a></span></div>
  <h1>HTML の省略によるサイズ最適化</h1>
  <section>
    <h2>Intro</h2>
    <p>とりあえず <a href="https://blog.jxck.io">blog.jxck.io</a> 以下については、基本的には静的ファイルを生成するスタイルで作ろうと思っている。</p>
    <p>手元に書いた Markdown を HTML に変換するスタイルで、これを行うツールは星の数ほどあるが、この変換時に前から思っていた HTML の最適化をやってみようと思った。</p>
    <p>結局そういうことができるツールはなさそうなので、 Markdown のパーサだけ借りてきて、 AST から構築する過程で省略を施した。</p>
    <p>単なる実験としてその結果を書いておく。</p>
  </section>
  <section>
    <h2>静的コンテンツの最適化</h2>
    <p>パフォーマンス改善の常套手段として、コンテンツの最適化がある。
    ただ、ここ最適化と言っているものには大きく二つある。</p>
    <ul>
      <li>gzip や png ではなく jpeg を使うなどのアルゴリズムにより経路上で圧縮する</li>
      <li>js や css から不要なスペースや改行を消すことで、コンテンツサイズを減らす</li>
    </ul>
    <p>どちらも今となってはツールなどが充実していて、特に導入は難しく無いと思う。</p>
    <p>ここで後者の最適化の一環として、 HTML を最適化したことはあるだろうか？
    あるとしても、それはスペース削除だけじゃ無いだろうか？</p>
  </section>
  <section>
    <h2>HTML の省略記法</h2>
    <section>
      <h3>タグそのもの</h3>
      <p><code>&lt;html&gt;</code>、 <code>&lt;head&gt;</code>、 <code>&lt;body&gt;</code> は、タグ自体を書かなくても良い場合があり、仕様では以下に定義がある。</p>
      <p><a href="https://html.spec.whatwg.org/multipage/syntax.html#syntax-tag-omission">https://html.spec.whatwg.org/multipage/syntax.html#syntax-tag-omission</a></p>
      <blockquote>An html element&#039;s end tag may be omitted if the html element is not immediately followed by a comment.</blockquote>
      <p>すぐ次がコメントでないなら、 <code>&lt;html&gt;</code> は省略しても良い。 <code>&lt;head&gt;</code> や <code>&lt;body&gt;</code> も同様だ。</p>
      <pre class="html"><code>&lt;!-- before --&gt;
&lt;!DOCTYPE html&gt;
  &lt;head&gt;
    &lt;title&gt;Hello&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Welcome to this example.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;

&lt;!-- after --&gt;
&lt;!DOCTYPE html&gt;
  &lt;title&gt;Hello&lt;/title&gt;
  &lt;p&gt;Welcome to this example.&lt;/p&gt;
&lt;/html&gt;</code></pre>
      <p>これは、 <code>&lt;html ng-app&gt;</code> みたいに、タグの要素によって何かを指定する必要があると消せないため、消せない・消しにくいことは多い。</p>
    </section>
    <section>
      <h3>閉じタグ</h3>
      <p>HTML には閉じタグの省略がゆるされるものがいくつかあり、仕様では以下に定義がある。</p>
      <p><a href="https://html.spec.whatwg.org/multipage/syntax.html#syntax-tag-omission">https://html.spec.whatwg.org/multipage/syntax.html#syntax-tag-omission</a></p>
      <p>例えば、 <code>&lt;/li&gt;</code> は以下の条件なら省略が可能だ。</p>
      <blockquote>An li element&#039;s end tag may be omitted if the li element is immediately followed by another li element or if there is no more content in the parent element.</blockquote>
      <ul>
        <li>その次にすぐ次の <code>&lt;li&gt;</code> がくる</li>
        <li>それ以上親 (<code>&lt;ul&gt;</code>, <code>&lt;ol&gt;</code>) に子要素が無い</li>
      </ul>
      <p>つまりこう書くことができる。</p>
      <pre class="html"><code>&lt;!-- before --&gt;
&lt;ul&gt;
  &lt;li&gt;one&lt;/li&gt;
  &lt;li&gt;two&lt;/li&gt;
  &lt;li&gt;three&lt;/li&gt;
&lt;/ul&gt;

&lt;!-- after --&gt;
&lt;ul&gt;
  &lt;li&gt;one
  &lt;li&gt;two
  &lt;li&gt;three
&lt;/ul&gt;</code></pre>
      <p>単純に閉じタグ 5byte x 3 = 15byte 分の容量が減っていることになる。
    </section>
    <section>
      <h3>attibute value の quote</h3>
      <p>もうひとつ、要素を囲む引用符(<code>&#039;</code>, <code>&quot;</code>) も省略が可能な場合があり、仕様では以下に定義がある。</p>
      <p><a href="https://html.spec.whatwg.org/multipage/introduction.html#a-quick-introduction-to-html">https://html.spec.whatwg.org/multipage/introduction.html#a-quick-introduction-to-html</a></p>
      <blockquote>The attribute value can remain unquoted if it doesn&#039;t contain space characters or any of &quot; &#039; ` = &lt; or &gt;. Otherwise, it has to be quoted using either single or double quotes.</blockquote>
      <p>つまり、スペースや <code>&quot; &#039; ` = &lt; or &gt;</code> が無ければ引用符はいらない。</p>
      <pre class="html"><code>&lt;!-- before --&gt;
&lt;input name=&quot;address&quot; maxlength=&quot;200&quot;&gt;

&lt;!-- after --&gt;
&lt;input name=address maxlength=200&gt;</code></pre>
      <p>要素一つにつき 2 byte の省略になる。
    </section>
  </section>
  <section>
    <h2>その最適化は現実的か？</h2>
    <section>
      <h3>好き嫌い</h3>
      <p>まず、こうした省略によって、例えば XML として崩れてるみたいなことを言う人もいる。</p>
      <p>気持ちはわかるが、そもそもこの程度を省略しなかったところで XML などではない。</p>
      <p>あくまで書いているのは HTML だし、 Markdown からの変換過程で最適化しているので、昨今のフロントのビルドタスクを見れば特段特別なことでもない。</p>
      <p>また、生成した結果は <a href="https://validator.w3.org/nu/">HTML Validator</a> で確認しているが問題は無い。</p>
      <p>HTML として問題が無いのであれば、 HTML に対応したツールでは使えることになる。使えない場合、少し厳しく言うとそのツールは HTML を正しく扱えてない、つまりバグということになる。
      まあ、そもそも HTML というのは、 XML と全く違い「緩い」部分が多いため、パースするのは非常に難しいので、しかたない。</p>
      <p>スクレイピングをしたいような場合は、手を抜いて片手間な正規表現で間に合わせようとせず、正しくパースできるライブラリを使うしかない。</p>
    </section>
    <section>
      <h3>効果</h3>
      <p>今回はやってみたかったからやっただけで、特に効果を期待してはいない。</p>
      <p>が、実際に閉じたタグを付けるのと比べれば TODO byte の削減にはなっている。</p>
      <p>また、レンダリングが遅くならないかという心配もあるかもしれないが、このブログエントリを単純にリロードし、 devtools を見てみても、全く問題は出ていない。</p>
      <p>むしろ、ペイロードが小さくなるということは、ネットワーク効率としてメリットが出るので、そちらへの影響が大きいだろう。</p>
    </section>
    <section>
      <h3>方法</h3>
      <p>普通の Web アプリでも、 HAML のように抽象度が高いフォーマットであれば、生成時に同様のオプションがあっても良さそうだが、 HAML ではずっと <a href="https://github.com/haml/haml/blob/master/TODO#L19">TODO</a> のままのようだ。</p>
      <p>Google の PageSpeed でも、こうした最適化は <a href="https://developers.google.com/speed/pagespeed/service/OptimizeHtml">サポートされていた</a>。</p>
      <p>ただ、一般にあまり普及した方法とはいえない気もする。</p>
    </section>
  </section>
  <section>
    <h2>結論</h2>
    <p>HTML を手書きするのではなく、テンプレートなどから生成する場合、もし省略できるのなら、「片手間にスクレイピングしようとしている人にとって面倒」というくらい以外には、特にデメリットは無いように思う。</p>
    <p>このサイトは、自分がソースを見た時に見やすいように、インデントと改行は消していないが、とりあえずこのまま行こうと思う。</p>
  </section>
</article>
<hr>
<footer>
  <address class="copyright">Copyright &copy; 2016 <a href=/>Jxck</a>. All Rights Reserved.</address>
</footer>
<script src="/assets/highlight.min.js"></script>
<script>window.onload = hljs.initHighlighting;</script>
</body>
</html>
