# [zopfli][performance] zopfli で静的コンテンツの gz 配信

## Intro

HTTP では `Accept-Encoding` と `Content-Encoding` でのネゴシエーションにより、 gz などで圧縮したコンテンツを転送することができる。本サイトでは zopfli を用いて gzip 形式の配信に対応した。


## Accept-Content-Encoding

クライアントが `Accept-Encoding: gzip` を指定して来た場合、サーバは `Content-Encoding: gzip` を付与し、 URI に指定されたコンテンツを gzip 圧縮して送信することができる。

リクエストが来てから圧縮を開始したり、動的なコンテンツを生成してから圧縮すると遅延が発生する可能性が高いため、通常は静的なファイルを事前に圧縮した状態で用意し、ネゴシエーションが成功した場合それを送るように構成する。

特にテキストベースの HTML, CSS, JavaScript などは、この圧縮の効果が高く、ペイロードが小さくなるためパフォーマンスの向上が期待できる。

逆に、 PNG, JPEG など圧縮形式の画像などについては、オーバーヘッドが発生しサイズが増える可能性もあるため、対象フォーマットの選択には注意が必要である。


## h2o の設定

本サイトをデプロイしている h2o もこれをサポートしている。

h2o.conf の設定では、以下のディレクティブを有効にする。

```
file.send-gzip: OFF
```

["file.send-gzip"](https://h2o.examp1e.net/configure/file_directives.html#file.send-gzip)


あとは、静的ファイルを `gzip` コマンドなどであらかじめ圧縮し、 `.gz` というファイル名で同じディレクトリに設置しておけば、あとは自動配信してくれる。


## zopfli

zopfli は Google が開発した圧縮アルゴリズム、およびその実装である。

[zopfli](https://github.com/google/zopfli)


圧縮結果が gzip 互換であるため、方式そのものは実質 gzip である。

gzip 圧縮は、ファイル内の一致部分を検出し圧縮するため、この一致部分の探索を入念に行えばより小さく圧縮できることが知られている。しかし、時間とのトレードオフであるため、一般的にはある程度の探索で止めている。

zopfli は、この探索を入念に行うことで、時間をかける代わりに、より小さく圧縮するという方針をとる。

サーバがリクエストを受けてから、もしくは動的コンテンツが生成されてから圧縮を実施するなどの場合は、時間の増加は問題になるが、静的ファイルは事前に時間をかけて圧縮できる場合もある。

本サイトは現状、 HTML をビルドして h2o で配信しているだけなので、ビルドプロセスの最後にこの圧縮を入れればよい。


## 時間と圧縮率の検証

本サイトのメインコンテンツはビルドした html である。これを、事前になるべく小さく圧縮しておきたいわけだが、あまり時間がかかるのも困る。

zopfli は、探索を繰り返す回数を調節できるため、この回数の増減による、圧縮率と実行時間を検証した。


### ベンチマーク

以下のように、前回の記事に対して zopfli コマンドを実行し、 time コマンドで実行時間を計測した。

```sh
$ time zopfli --i10 -c loading-css-over-http2.html
```

`--i` が探索回数であり、これを増やせばより小さく圧縮できるが、時間がかかる。
デフォルトは `i = 15` であるため、 `10..100` まで増やしながら実行した。

最初の段は、元のファイルサイズ、二段目は `gzip` コマンドの結果である。


```txt
| i    | Time    | Byte  |
| ---- | ------- | ----- |
| orig | -       | 17497 |
| gzip | -       | 5348  |
|  10  | 0:00.10 | 3420  |
|  20  | 0:00.14 | 3424  |
|  30  | 0:00.16 | 3480  |
|  40  | 0:00.20 | 3420  |
|  50  | 0:00.23 | 3348  |
|  60  | 0:00.26 | 3440  |
|  70  | 0:00.29 | 3436  |
|  80  | 0:00.32 | 3532  |
|  90  | 0:00.35 | 3560  |
| 100  | 0:00.38 | 3536  |
```
```
0:00.10
0:00.14
0:00.16
0:00.20
0:00.23
0:00.26
0:00.29
0:00.32
0:00.35
0:00.38


17497
5348 
3420 
3424 
3480 
3420 
3348 
3440 
3436 
3532 
3560 
3536 
```
