# [http] Header に使える文字

## Intro

RFC ではこうなっている。


```bnf
HTTP-message   = start-line
                   *( header-field CRLF )
                   CRLF
                   [ message-body ]

header-field   = field-name ":" OWS field-value OWS

field-name     = token


token          = 1*tchar

tchar          = "!" / "#" / "$" / "%" / "&" / "'" / "*"
               / "+" / "-" / "." / "^" / "_" / "`" / "|" / "~"
               / DIGIT / ALPHA
               ; any VCHAR, except delimiters
```

つまり field-name に使えるのは tchar のリスト。

ちなみに picohttpparser では以下のように(先頭のみ?)チェックしてる。

https://github.com/kazuho/p5-http-parser-xs/commit/6e2f219bf51125a4851aceb5d04bd55c5f8252ad

先頭が `:` でも通ってしまうという issue 対応のバックポートっぽい。

https://github.com/kazuho/p5-http-parser-xs/issues/5

token_char_map は 0x00~0xFF までの数字に対応する ASCII 文字を、使える(1)か使えない(0)かのフラグで埋めた配列。

```c
static const char* token_char_map =
  "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
  "\0\1\1\1\1\1\1\1\0\0\1\1\0\1\1\0\1\1\1\1\1\1\1\1\1\1\0\0\0\0\0\0"
  "\0\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\0\0\0\1\1"
  "\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\1\0\1\0\1\0"
  "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
  "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
  "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
  "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";
```

buf の先頭を char にして渡すと、その数字を添え字として配列からフラグを取り出して、
0 なら使えない文字なので `!` して `return -1` してる。

```c
if (! token_char_map[(unsigned char)*buf]) {
  *ret = -1;
  return NULL;
}
```

イメージとしてはこう。 128 以降は ASCII 圏外なので全部 0 で埋めてある。

なんかで使えそうな配列なのでメモ。

```c
static const char *token_char_map = "\0"// 0	00	00000000	NUL	null
                                    "\0"// 1	01	00000001	SOH	start of header
                                    "\0"// 2	02	00000010	STX	start of text
                                    "\0"// 3	03	00000011	ETX	end of text
                                    "\0"// 4	04	00000100	EOT	end of transmission
                                    "\0"// 5	05	00000101	ENQ	enquiry
                                    "\0"// 6	06	00000110	ACK	acknowledge
                                    "\0"// 7	07	00000111	BEL	bell
                                    "\0"// 8	08	00001000	BS	backspace
                                    "\0"// 9	09	00001001	HT	horizontal tab
                                    "\0"// 10	0A	00001010	LF	line feed
                                    "\0"// 11	0B	00001011	VT	vertical tab
                                    "\0"// 12	0C	00001100	FF	form feed
                                    "\0"// 13	0D	00001101	CR	enter / carriage return
                                    "\0"// 14	0E	00001110	SO	shift out
                                    "\0"// 15	0F	00001111	SI	shift in
                                    "\0"// 16	10	00010000	DLE	data link escape
                                    "\0"// 17	11	00010001	DC1	device control 1
                                    "\0"// 18	12	00010010	DC2	device control 2
                                    "\0"// 19	13	00010011	DC3	device control 3
                                    "\0"// 20	14	00010100	DC4	device control 4
                                    "\0"// 21	15	00010101	NAK	negative acknowledge
                                    "\0"// 22	16	00010110	SYN	synchronize
                                    "\0"// 23	17	00010111	ETB	end of trans. block
                                    "\0"// 24	18	00011000	CAN	cancel
                                    "\0"// 25	19	00011001	EM	end of medium
                                    "\0"// 26	1A	00011010	SUB	substitute
                                    "\0"// 27	1B	00011011	 ESC	escape
                                    "\0"// 28	1C	00011100	 FS	file separator
                                    "\0"// 29	1D	00011101	GS	group separator
                                    "\0"// 30	1E	00011110	RS	record separator
                                    "\0"// 31	1F	00011111	US	unit separator
                                    "\0"// 32	20	00100000	Space	space
                                    "\1"// 33	21	00100001	!	exclamation mark
                                    "\0"// 34	22	00100010	"	double quote
                                    "\1"// 35	23	00100011	#	number
                                    "\1"// 36	24	00100100	$	dollar
                                    "\1"// 37	25	00100101	%	percent
                                    "\1"// 38	26	00100110	&	ampersand
                                    "\1"// 39	27	00100111	'	single quote
                                    "\0"// 40	28	00101000	(	left parenthesis
                                    "\0"// 41	29	00101001	)	right parenthesis
                                    "\1"// 42	2A	00101010	*	asterisk
                                    "\1"// 43	2B	00101011	+	plus
                                    "\0"// 44	2C	00101100	,	comma
                                    "\1"// 45	2D	00101101	-	minus
                                    "\1"// 46	2E	00101110	.	period
                                    "\0"// 47	2F	00101111	/	slash
                                    "\1"// 48	30	00110000	0	zero
                                    "\1"// 49	31	00110001	1	one
                                    "\1"// 50	32	00110010	2	two
                                    "\1"// 51	33	00110011	3	three
                                    "\1"// 52	34	00110100	4	four
                                    "\1"// 53	35	00110101	5	five
                                    "\1"// 54	36	00110110	6	six
                                    "\1"// 55	37	00110111	7	seven
                                    "\1"// 56	38	00111000	8	eight
                                    "\1"// 57	39	00111001	9	nine
                                    "\0"// 58	3A	00111010	:	colon
                                    "\0"// 59	3B	00111011	;	semicolon
                                    "\0"// 60	3C	00111100	<	less than
                                    "\0"// 61	3D	00111101	=	equality sign
                                    "\0"// 62	3E	00111110	>	greater than
                                    "\0"// 63	3F	00111111	?	question mark
                                    "\0"// 64	40	01000000	@	at sign
                                    "\1"// 65	41	01000001	A	 
                                    "\1"// 66	42	01000010	B	 
                                    "\1"// 67	43	01000011	C	 
                                    "\1"// 68	44	01000100	D	 
                                    "\1"// 69	45	01000101	E	 
                                    "\1"// 70	46	01000110	F	 
                                    "\1"// 71	47	01000111	G	 
                                    "\1"// 72	48	01001000	H	 
                                    "\1"// 73	49	01001001	I	 
                                    "\1"// 74	4A	01001010	J	 
                                    "\1"// 75	4B	01001011	K	 
                                    "\1"// 76	4C	01001100	L	 
                                    "\1"// 77	4D	01001101	M	 
                                    "\1"// 78	4E	01001110	N	 
                                    "\1"// 79	4F	01001111	O	 
                                    "\1"// 80	50	01010000	P	 
                                    "\1"// 81	51	01010001	Q	 
                                    "\1"// 82	52	01010010	R	 
                                    "\1"// 83	53	01010011	S	 
                                    "\1"// 84	54	01010100	T	 
                                    "\1"// 85	55	01010101	U	 
                                    "\1"// 86	56	01010110	V	 
                                    "\1"// 87	57	01010111	W	 
                                    "\1"// 88	58	01011000	X	 
                                    "\1"// 89	59	01011001	Y	 
                                    "\1"// 90	5A	01011010	Z	 
                                    "\0"// 91	5B	01011011	[	left square bracket
                                    "\0"// 92	5C	01011100	\	backslash
                                    "\0"// 93	5D	01011101	]	right square bracket
                                    "\1"// 94	5E	01011110	^	caret / circumflex
                                    "\1"// 95	5F	01011111	_	underscore
                                    "\1"// 96	60	01100000	`	grave / accent
                                    "\1"// 97	61	01100001	a	 
                                    "\1"// 98	62	01100010	b	 
                                    "\1"// 99	63	01100011	c	 
                                    "\1"// 100	64	01100100	d	 
                                    "\1"// 101	65	01100101	e	 
                                    "\1"// 102	66	01100110	f	 
                                    "\1"// 103	67	01100111	g	 
                                    "\1"// 104	68	01101000	h	 
                                    "\1"// 105	69	01101001	i	 
                                    "\1"// 106	6A	01101010	j	 
                                    "\1"// 107	6B	01101011	k	 
                                    "\1"// 108	6C	01101100	l	 
                                    "\1"// 109	6D	01101101	m	 
                                    "\1"// 110	6E	01101110	n	 
                                    "\1"// 111	6F	01101111	o	 
                                    "\1"// 112	70	01110000	p	 
                                    "\1"// 113	71	01110001	q	 
                                    "\1"// 114	72	01110010	r	 
                                    "\1"// 115	73	01110011	s	 
                                    "\1"// 116	74	01110100	t	 
                                    "\1"// 117	75	01110101	u	 
                                    "\1"// 118	76	01110110	v	 
                                    "\1"// 119	77	01110111	w	 
                                    "\1"// 120	78	01111000	x	 
                                    "\1"// 121	79	01111001	y	 
                                    "\1"// 122	7A	01111010	z	 
                                    "\0"// 123	7B	01111011	{	left curly bracket
                                    "\1"// 124	7C	01111100	|	vertical bar
                                    "\0"// 125	7D	01111101	}	right curly bracket
                                    "\1"// 126	7E	01111110	~	tilde
                                    "\0"// 127	7F	01111111	DEL	delete
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0"
                                    "\0";
```
