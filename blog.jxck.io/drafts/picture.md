# 画像最適化戦略 &lt;picture&gt; 編

## Intro

本サイトで使用している PNG/JPEG/WebP 画像を、対応デバイスと、 Device Pixel Ratio に対して最適なサイズで出し分けるために、 `<picture>` 要素を適用した。


## 画像の出し分け

本サイトでは、ここまでに最適化を実施した PNG/JPEG に加えて、対応するブラウザにのみ WebP を提供している。

WebP の対応は `<picture>` を用いて行い、ブラウザに判断を委ねることで UA や Accept ヘッダによるサーバサイドでの分岐無しに対応を実施した。


一方、それぞれの画像のサイズは、基本的に `<img>` に指定する `width`, `height` 値に会わせてリサイズを実施している。

しかし、例えば Pevice Pixel Ratio が大きい Retina 対応端末などには、 大きいサイズのファイルを提供しなければ、拡大表示による画像の荒れが発生してしまう。

そこで、同一画像でいくつかのファイルサイズを用意し、同じく `<picture>` を用いて最適なものをブラウザに判断させる形で対応を行った。


## 最適な画像を決定する変数

サイズ・フォーマット的に最適なイメージは、大きく端末とブラウザの組み合わせで変わる。
具体的には、現状以下の分岐を考慮する必要がある。

- WebP に対応しているか(ブラウザの分岐)
- ViewPort Size はいくつか(端末サイズの分岐)
- DPI はいくつか(retina 対応)


### Picture



### サイズ最適化

PNG/JPEG などのラスタ形式画像において、サイズとは基本的に縦横に敷き詰められた正方形の数を指す。
100x100 個の正方形でなる画像は、 100x100 で表示すれば基本的には問題ない。
しかし、 200x200 で表示すれば、同じ正方形を縦横二つ並べて大きくしないといけないため、鮮明さが落ちる。

もし画像の綺麗さに対して敏感な人が作れば、基本的に縦長なモバイル端末を横に倒した時は、表示している画像を拡大するのではなく、大きな画像に置き換えたいと思うかもしれない。

ただし、表示の大きさはスクリーンの大きさと必ずしも比例しない。
Retina ディスプレイは、通常のスクリーンよりも、スクリーン上に並ぶ正方形が小さいサイズになっている。
スクリーンが持つ 1x1 を描画するための四角は **device pixel** といい、これが小ほど **画面密度(device pixel ratio)** が高いと表現する。

`x2` という解像度であれば、 100x100 を素直に表示すると、同じスクリーンサイズの非 Retina ディスプレイで表示した時の 50x50 の見た目になってしまう。
よって、 Retina を持つ端末は、実際に自分が持っている **device pixel** と、 CSS で指定する **css pixel** を分けることにした。
つまり、 css で 100x100 (css pixel)で表示するように指定された画像は、勝手に 200x200 (device pixel)に拡大して表示することで、製作者が想定する **描画サイズ(見た目の大きさ)** になるようにしている。

ところが、サイズが良くても解像度は前述と同じ理由で荒くなる。
そのため、 Retina に対応するためには、あらかじめ 200x200 で作った画像も用意し、出し分ける必要がある。
今では `x3` の端末もあるため、 300x300 の画像も必要になる。将来的にこれが増えていく可能性もゼロではないだろう。

逆に、大きいサイズの画像を小さく表示する分には、見た目上の問題は通常無い。
従って、 300x300 を用意しておき、相手がだれであろうとそれを送って、 200x200 なり 100x100 なり都合の良いサイズで表示してもらえば、 **見た目の問題** は解決する。

しかし、 100x100 のデータ必要な端末に 300x300 の画像を送るのは単純に無駄だ。
単純計算で、本来必要なデータの 9 倍近いデータを送ることになる。

最適な画像を出し分けるのは、大事な一方、実は非常に複雑なのだ。


## 対応方法

今回は、デバイスのサイズや解像度などに応じて、適切なサイズの画像を出し分けられるようにする設定を考える。

特に、複雑なインタラクションは考えない。




加えて、例えばデバイスを横に持ってワイドスクリーンになった場合に、画像を大きくしたいなどとなれば、必要なサイズはまた変わるだろう。








|    format |   size |
|:----------|-------:|
| jxck.png  |   3.8K |
| jxck.webp |   1.8K |
| jxck.svg  |   291B |

