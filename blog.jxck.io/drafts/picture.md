# [picture][image][performance] 画像最適化戦略 &lt;picture&gt; 編

## Intro

本サイトで使用している PNG/JPEG/WebP 画像を、対応デバイスと、 Device Pixel Ratio に対して最適なサイズで出し分けるために、 `<picture>` 要素を適用した。


## 画像の出し分け

本サイトでは、ここまでに最適化を実施した PNG/JPEG に加えて、 WebP 形式を提供している。

WebP の対応は `<picture>` を用いて行い、ブラウザに判断を委ねることで UA や Accept ヘッダによるサーバサイドでの分岐無しに実施した。


一方、それぞれの画像のサイズは、基本的に `<img>` に指定する `width`, `height` 値に会わせてリサイズを実施している。

しかし、例えば Device Pixel Ratio が大きい Retina 対応端末などには、 大きいサイズのファイルを提供しなければ、拡大表示による画像の荒れが発生してしまう。

そこで、同一画像でいくつかのファイルサイズを用意し、同じく `<picture>` を用いて最適なものをブラウザに判断させる形で対応を行った。


## 最適な画像を決定する変数

サイズ・フォーマット的に最適なイメージは、主に端末とブラウザの組み合わせで変わる。
具体的には、現状以下の分岐を考慮する必要がある。

- WebP に対応しているか(ブラウザの分岐)
- ViewPort Size はいくつか(端末サイズの分岐)
- DPI はいくつか(端末 Retina 対応)


### サイズ最適化

PNG/JPEG などのラスタ形式画像において、サイズとは基本的に縦横に敷き詰められた正方形の数を指す。
100x100 個の正方形でなる画像は、 100x100 で表示すれば基本的には問題ない。
しかし、 200x200 で表示すれば、同じ正方形を縦横二つ並べて大きくしないといけないため、鮮明さが落ちる。

もし画像の綺麗さに対して敏感な人が作れば、基本的に縦長なモバイル端末を横に倒した時は、表示している画像を拡大するのではなく、大きな画像に置き換えたいと思うかもしれない。

ただし、表示の大きさはスクリーンの大きさと必ずしも比例しない。
Retina ディスプレイは、通常のスクリーンよりも、スクリーン上に並ぶ正方形が小さいサイズになっている。
スクリーンが持つ 1x1 を描画するための四角は **device pixel** といい、これが小ほど **画面密度(device pixel ratio)** が高いと表現する。

`x2` という解像度であれば、 100x100 を素直に表示すると、同じスクリーンサイズの非 Retina ディスプレイで表示した時の 50x50 の見た目になってしまう。
よって、 Retina を持つ端末は、実際に自分が持っている **device pixel** と、 CSS で指定する **css pixel** を分けることにした。
つまり、 css で 100x100 (css pixel)で表示するように指定された画像は、勝手に 200x200 (device pixel)に拡大して表示することで、製作者が想定する **描画サイズ(見た目の大きさ)** になるようにしている。

ところが、サイズが良くても解像度は前述と同じ理由で荒くなる。
そのため、 Retina に対応するためには、あらかじめ 200x200 で作った画像も用意し、出し分ける必要がある。
今では `x3` の端末もあるため、 300x300 の画像も必要になる。将来的にこれが増えていく可能性もゼロではないだろう。

逆に、大きいサイズの画像を小さく表示する分には、見た目上の問題は通常無い。
従って、 300x300 を用意しておき、相手がだれであろうとそれを送って、 200x200 なり 100x100 なり都合の良いサイズで表示してもらえば、 **見た目の問題** は解決する。

しかし、 100x100 のデータ必要な端末に 300x300 の画像を送るのは単純に無駄だ。
単純計算で、本来必要なデータの 9 倍近いデータを送ることになる。

最適な画像を出し分けるのは、大事な一方、実は非常に複雑なのだ。


## `<picture>` による対応

今回は、デバイスのサイズや解像度などに応じて、適切なサイズの画像を出し分けられるようにする設定を考える。
ただし、 Media Query を多用するような、複雑なインタラクションは考慮しない。

### 現状

すでに WebP を出し分けるために、画像は以下のように `<picture>` を指定している。

```html
<picture>
  <source type=image/webp srcset=hero-image.webp>
  <img src=hero-image.png alt="hero image">
</picture>
```


ここに対して Hi-DPI 対応の、大きいサイズの画像を指定する。

基本的に Width-Height は変更しない前提であれば、 DPI が x2, x3... と増える場合にサイズが x2, x3... となる画像を提供することになる。


### Media Query の指定

Media Query を用いて DPR 値で分岐した場合以下のように指定できる。

```html
<picture>
  <source type=image/webp srcset=300x300.webp media="min-device-pixel-ratio: 2.5">
  <source type=image/webp srcset=200x200.webp media="min-device-pixel-ratio: 1.5">
  <source type=image/webp srcset=100x100.webp>

  <source type=image/png srcset=300x300.png media="min-device-pixel-ratio: 2.5">
  <source type=image/png srcset=200x200.png media="min-device-pixel-ratio: 1.5">
  <source type=image/png srcset=100x100.png>

  <img src=100x100.png alt="select with media query">
</picture>
```


### sizes の指定

sizes を用いて、画像のサイズを明示した場合以下のように指定できる。

```html
<picture>
  <source type=image/webp sizes=100px
          srcset="100x100.webp 100w,
                  200x200.webp 200w,
                  300x300.webp 300w">

  <source type=image/png sizes=100px
          srcset="100x100.png 100w,
                  200x200.png 200w,
                  300x300.png 300w">

  <img src=100x100.png alt="select with picture source">
</picture>
```


### pros/cons

Media Query を用いた指定は、コンテンツ側が「この場合はこれ」とブラウザに指定してることになる。
ブラウザはそのクエリを評価し、その結果に忠実に画像を選択することになる。

sizes の指定は、コンテンツ側が「こういう選択肢がある」と提示し、ブラウザがそこから選択することになる。

srcset で画像の実際のサイズを `w` で指定し、それを表示したいサイズを `sizes` で指定している。

ブラウザは

> DPI x2 のディスプレイなので 100px で表示するのに最適なのは 200w の画像だ

といった具合に画像を選択する。

両者の一番の違いは「**ブラウザに考える余地があるかどうか**」である。

もし、将来より大きい DPI や、今とは違う表示サイズや、表示形式から違うディスプレイが出て来た場合、後者はそれを考慮して画像を選べるが、前者はコンテンツに手を入れて対応して行く必要が有る。

また、モバイル端末自身が

> ネットワーク環境が悪いため、 DPI は x3 だがあえて 100w の画像を取得しよう

といったこともできる可能性がある。

本サイトは、こうした選択をブラウザに任せることとし、後者の指定方法を選択することにした。
