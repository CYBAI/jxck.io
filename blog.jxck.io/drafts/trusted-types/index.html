<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Security-Policy" content="trusted-types unsafe escape">
</head>

<script id=sink></script>
<body>
  <h1>Trusted Types demo</h1>

  <dl>
    <dt>trusted</dt>
    <dd id=trusted></dd>
    <dt>escaped</dt>
    <dd id=escaped></dd>
    <dt>raw</dt>
    <dd id=raw></dd>
  </dl>


  <script>
  const $ = document.querySelector.bind(document);

document.querySelector('body').innerHTML = '<img src=/ onerror="alert(10)">';

  (function() {
    // この関数スコープでのみ有効な Policy
    const policy = TrustedTypes.createPolicy('unsafe', {
      'createHTML': (unsafe) => {
        // 何もしない(型でくるむだけ)
        return unsafe;
      }
    });
    const trustedValue = policy.createHTML('<b>trusted input</b>');
    $('#trusted').innerHTML = trustedValue
  })();


  // Create escaping policy
  const expose = true
  TrustedTypes.createPolicy('escape', {
    'createHTML': (unsafe) => {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  }, expose);
  const escapedValue = TrustedTypes.getExposedPolicy('escape').createHTML('<b>escape me</b>');
  $('#escaped').innerHTML = escapedValue


  //TrustedTypes.createPolicy('exploit', {
  //  'createHTML': (unsafe) => unsafe
  //});


  //try {
  //  $('#raw').innerHTML = 'raw string'
  //} catch (err) {
  //  console.error(err)
  //}


  console.time()
  for (let i=0; i<100000; i++) {
    $('#escaped').innerHTML = escapedValue
  }
  console.timeEnd()

  $('#sink').innerHTML = "alert(10)"

  </script>
</body>
