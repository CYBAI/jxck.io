# dotfiles の便利コマンド集

## Intro

前回の selects について反応をもらったところ、他にもあるなら紹介して欲しいと言われた。

こういうオレオレコマンドはおそらく多くの人が持ってると思うが、自分が極々特定の問題を解決するために作ったものだと、確かに表に出てくることは少ないかもしれない。

別にだれかが使うことなど想定してなかったが、こういうマイクロコマンドを量産するということ自体についても含めて、少し書いてみる。


## 自作コマンドのススメ

世界には多くの便利なライブラリや、パッケージがあるが、それらは汎用的に作られているため、自分のわがままが全て叶うとは限らない。

例えば ls のオプションが自分の思う通りいかない場合、その範囲で諦めてきたが、まあ自分しか使わないコマンドだったら自分が一番気持ち良いように書いてしまっても良いと思う。そのせいで何かあっても自己責任だ。

そう振り切ると、コマンドを書くのは、単純に楽しい。

なんとなく手が進まない時に、とりあえず新しいコマンドの断片を書いたり、いつも書いてるコマンドのメンテをしながら手を動かしていれば、おのずとエンジンがかかったりする。

あと、最近はコードを OSS として公開することのメリットも十分浸透し、そこでドキュメントやテストが付属していることの価値や、その作法も成熟してきた。でもちゃんとやるのは大変だったりする。

他に誰も使ってない自分だけのコードは、自分だけがわかればいいと割り切ることで、自分が必要だと思う範囲の実装とテストとドキュメントで完結できる。

自分だけが使うプラットフォームで動けば良いし、自分が使いたい機能を存分に使って実験もできる。

イケてる PR が来ることは無い代わりに、面倒な issue が来ることもない。

作法に則る負荷から完全に解放されたコードを書くというのも、趣味として気が楽だったりする。

という前置きは完全に後付けで、自分が書き散らかした、でも思った以上に手元で活躍してくれているコマンドを紹介する。


## 方針

基本的には以下のような形で作っている

- ruby か sh か zsh 関数で書く
- `$DOTFILES/bin` にパスを通してそこに全て入れる。
- 外部ライブラリなどは使わない
- 1 ファイルで完結させる。
- `-h` で使い方が思い出せるようにする
- `-t` でテストが走るようにする(あるなら)
- 長いこと使ってないコマンドは消す
- windows は一切考えない
- 自分が使わないコマンドなら名前がかぶってもいい


## 紹介対象

よく見ると結構あったが、今回は以下を紹介する。

- ascii
- bin
- chsh.sh
- cleanup.sh
- color
- diff-highlight
- dock
- ghbin
- ghlatest
- gobrew
- h2j
- histuniq
- http
- https
- httpx
- ip
- l
- plot
- polish.sh
- proxy.sh
- selects
- singler
- slink.sh
- space.rb
- sys
- uncolor.sh
- upload
- ws
- wss

使用頻度が高い順に紹介する。


## l

ls が気に食わないから自分で書いたもの。

理想としては github のように、以下の順で並んで欲しい。

1. .dir
2. dir
3. .file
4. file

そして、 symlink や executable は、色が別なだけでなく、種類ごとにまとまってて欲しい。
もちろん同種の中では、名前順にソートして欲しい。

`ls` はオプションが多いが、色々つけてもなかなか思うような見た目にならない。
また Mac では coreutils で入れないと Linux とオプションも違ってまた面倒。

ということで書いてしまうことにした。


```shell
rwxr-xr-x jxck staff    68B 2016-02-05 02:01 .dir
rwxr-xr-x jxck staff    68B 2016-02-05 02:00 dir
rwxr-xr-x jxck staff     5B 2016-02-05 02:02 .sym -> .file
rwxr-xr-x jxck staff     4B 2016-02-05 02:01 sym -> file
rwxr-xr-x jxck staff     0B 2016-02-05 02:02 .exec
rwxr-xr-x jxck staff     0B 2016-02-05 02:01 exec
rw-r--r-- jxck staff     0B 2016-02-05 02:01 .file
rw-r--r-- jxck staff     0B 2016-02-05 02:01 file
```

これでどんな環境でも気に入った並びで ls できて気持ちいい。

一番よく使うコマンドこそ、気持ちよくあるべきだと思う。


## http/https

http/https サーバを一瞬で立ち上げるためのコマンド。

昔は Python の SimpleHTTPServer をワンライナーで使っていたが、常用するには足りないものが多い。


- 常にその場をルートにしたい
- `.md` や `.webp` など、デフォルトが大抵 octet-stream なので、 content-type を簡単に付与したい
- /favicon.ico も 404 になるとログが邪魔なのでつけたい
- 実験やテストで HTTP ヘッダを簡単に付与したい
- random な値を返す URL とかあると実験するとき便利
- https は、内部で証明書を生成してくれると便利


ということで Webrick で書いた。これは非常に重宝している。
ワンファイルで動くようにしてるので、必要なものはソースを直接いじって変えたりして使ってる。

特に Service Worker や最近の新しい API をいじる上で一瞬で上がる HTTPS サーバが無いとやってられない。
(合わせてローカル用のオレオレ証明書を作り、 OS に食わせておくとなお良い)

Web 開発を専門に行うので、こうした手に馴染んだ、よく言うことを聞いてくれるサーバの存在は大事だ。


## ws/wss

websocket サーバを一瞬で立ち上げるコマンド。

送ったデータは、接続者全員にブロードキャストするようにしてるので、何かを書き始める時に非常に使いやすい。

中では websocketd を呼び出しているだけだが、 websocketd 自体がバイナリ一つで動くのでこれを使ってる。


## bin

2, 10, 16 進数の変換を一瞬でやるコマンド。

自分が頭が悪いので、進数変換が暗算ではぱっとできない。
これをするだけのコマンドだが、パケットを読んだり書く時に重宝してる。


```sh
$ bin 0xff
111,111 0xFF 255

$ bin 0b1010
1010 0xA 10

$ bin 256
0001,0000,0000 0x100 256
```


今は Erlang という、 2, 10, 16 進数を全てリテラルで書けて、パターンマッチでサーバが書ける素晴らしい言語に出会えたので、サーバを書く場面では出番が減ってる。


## ghbin/ghlatest

`ghbin` は github のリリースからバイナリを落としてきて解凍して配置するコマンド。
`ghlatest` はリポジトリ全体を clone すると大きすぎる場合に、アーカイブをダウンロードするコマンド。

これらは、 brew/apt-get などに上がってない、もしくは上がってても最新が欲しいプロダクトを、ダウンロードするスクリプト($DOTFILES/install/*)から呼ぶために共通化したコマンドだ。

例えば h2o の最新が欲しいけど clone すると時間がかかるので、 ghlatest を使う。

```sh
#!/bin/sh
ghlatest h2o/h2o
cd $DEST
cmake -DCMAKE_INSTALL_PREFIX=$DOTFILES/local/h2o -DWITH_MRUBY=on -DWITH_BUNDLED_SSL=on .
make
make install
```

peco は、まだ apt-get に上がってないが、 ghbin を使えば go がなくてもバイナリを取得できる。

```hs
#!/bin/sh
ghbin peco/peco
```

ただ、 github の release の運用はプロジェクト次第なので、動かないこともある。


## cleanup

$HOME 以下のゴミファイルを掃除するコマンド。

$HOME に気がつくと謎ファイルが溜まってないだろうか?
重要なファイルに混じって、たまにしか使わないツールが残す設定ファイルや、履歴ファイル、エラーログなどが累積する。

放っておいてもいいが、大事なファイルがゴミファイルに埋もれている状態はあまり健全だと思わないので、知らないファイルは、用途を調べ、自分にとって不要な場合は消している。
毎回調べても忘れるので、その要らないファイル集をまとめて消すコマンドだ。


```sh
$ cleanup.sh
```

ちなみに、謎ファイルの正体は、以下などにまとまっている。

- http://library.gnome.org/admin/system-admin-guide/stable/appendixa-0.html.ja
- http://uguisu.skr.jp/Windows/setting.html


## color

標準出力をなんでも雑に色付けするコマンド。


例え適当でも、規則的に色がついてるだけで出力の視認性は格段に向上することがある。
`--color` 的なオプションに対応してないコマンドと使う。

どんなファイルも色付けするので、個々のフォーマットを正確にパースすることなどもちろんしてない。
代わりに以下のように色をつける。

- 基本はスペースで区切り、色を変える
- 明るい色と暗めの色が交互に出す
- `"a b"`、 `[a b]`、 `(a b)` など囲まれてるものは、スペースがあっても単一色

access.log を色付けるとこうなる。


```
TODO:
```


## plot


`sort` と `uniq` した結果をプロットするコマンド。


以下のようなランキングはワンライナーの頻出パターンだと思う。

```sh
$ cat access.log | cut -f7 | sort | uniq -c | sort -nr
572 /
118 /assets/js/sw.js?ver=2
103 /assets/img/jxck.png
84 /assets/font/NotoSansCJKjp-Jxck-Regular.woff?ver=20163014
75 /assets/js/ga.js
70 /assets/img/jxck.svg
64 /assets/css/main.css
64 /assets/css/header.css
64 /assets/css/footer.css
```

これを視覚的に、ターミナル上で plot したいというだけのコマンドだ。
(uniq -c のフォーマットに合わせている)


```sh
$ cat access_log | cut -f7 | sort | uniq -c | sort -nr | plot
/                       ****************************************************************************************************************************************************** 573
/assets/js/sw.js?ver=   ******************************* 119
/assets/img/jxck.png    ************************** 103
/feeds/atom.xml         *********************** 88
/assets/font/NotoSans   ********************* 84
/assets/js/ga.js        ******************* 75
/assets/img/jxck.svg    ****************** 70
/assets/css/main.css    **************** 64
/assets/css/header.cs   **************** 64
/assets/css/footer.cs   **************** 64
```

gnuplot のオプション調べるより、書いた方が早かった。


## gobrew

Go のインストールや GOPATH の変更が簡単にできるコマンド。

今やいろいろなツールがあるし、自分で同様のツールを作っている人も多いだろう。

自分は env 系方式よりも brew 系方式の方が好きなので、そんな感じに必要最小限のものを備えている。


```sh
$ gobrew install 1.2
$ gobrew use 1.2
$ gobrew version
$ gobrew list
$ gobrew here
$ gobrew path
$ gobrew tools
$ gobrew -h
```


## histuniq

history ファイルを綺麗に整理するコマンド。

`.zsh_history` はエンジニアにとって重要な資産だと思う。

サーバ内などでは、履歴が正しく残ることが重要だが、開発環境では作業履歴よりも、過去に実行したコマンドを peco で絞り込みながら呼び出す用途を重要視している。

そこで、呼び出す際にリスト内に重複があると邪魔だ。絞り込む際に全く同じコマンドは一回出れば良い。

このコマンドは、出現順を維持したまま、過去に遡って重複を排除してくれる。


```
$ histuniq
```


`hist_ignore_dups` という zsh のオプションで、連続する重複は省けるが、間に一つでも別のコマンドが入ると、重複とはみなされずそのまま残る。

ファイルが大きくなったらダイエットも兼ねてたまにこのコマンドを実行すると、 history の呼び出しがスッキリして気持ちよくなる。


## space

文章の全角と半角の間に、スペース入れる派と入れない派を、一瞬で切り替えるコマンド。


技術文書を書く時に、半角と全角の間にスペースを入れる派と、入れない派がある。

自分は入れる派だが、出版社によっては入れない派が多いようだ。

しかし、入れないように注意して書くのは非常にストレスが多い。

そこで一括して削除するために書いたコマンドがこれだ。

入力は markdown を前提にしてあるためん、リスト貴方の `1. あ` みたいなスペースは残すようにしている。


で、もう少し頑張って逆も実装した。全ていい感じにスペースを追加するモードだ。

これをつけたことによって、一旦全部消して、全部付ければ、つけ忘れの整形になる便利コマンドが完成した。

最近 textlint にも入ったような噂を聞いたが、単一の目的が一瞬で達成できるのでこれを使ってる。

@inao さんに、「スペースを消せ」と言われたスペース派には便利かもしれない。


>>>>>>>>>>>>>>>>
# 英語と日本語の間の半角スペースを入れたり消したりする

技術文書(でなくてもそうかもしれないけど)を書くスタイルで、半角と全角の間に半角スペースを入れるか入れないかというのがある。

例えばこういうの

```
有) わたし Linux ちょっとできます。
無) わたしLinuxちょっとできます。
```

自分は「有り」で書くタイプなのだけど、前に @inao さんに「消せ」といわれて消した時に書いたスクリプトが、地味に便利で使っているうちに育ってきた。

https://github.com/dotfiles/bin/space.rb


## 要件

雑に消すだけなら難しくないんだけど、執筆においてはこのくらいができるとうれしい。

- 消したくない場所もある
- 消したスペースを戻せるようにしたい


一つ目の要件は、単純に「半角と全角の間のスペースを消す」だと

```
# りすと

- あ
- い
- う
```

が

```
#りすと

-あ
-い
-う
```

になったりしてしまう。 Markdown は半角記号を多用するので、そこをいい感じに残したい。
Markdown 以外にもいくつかあるが、そこは完全に自分好みに書いた。

二つめの要件は、半角スペースがない文章に対して逆のことをしたいというもの。
また、「消す」->「入れる」をやると整形になる。

```
元) わたし  Linuxちょっとできる
消) わたしLinuxちょっとできる
入) わたし Linux ちょっとできる
```

っていうのがこちら。

最初は単純な sed から書きはじめて、 dotfiles に入れていただけのものがはじまりなので、
Markdown パーサだとか、形態素解析だとか、そういう外部ライブラリを一切使ってない。

が、自分がブログなどを雑に書く分には十分動いてるので、置いておく。


>>>>>>>>>>>>>>>>


## path

path って打ったら、パスが出て欲しい。

$PATH の中身を改行しつつ表示してくれる。
環境をメンテしてる時に重宝する。


## proxy

proxy って打ったら、 proxy が出て欲しい。

proxy の設定を改行しつつ表示してくれる。
社内 Proxy に阻まれたときに重宝。


## ip

IP って打ったら IP アドレスが出て欲しい。

NIC の IP アドレスを出すだけのコマンド。
ネットワーク系コマンドは、出力が汚いことが多い気がしてる。


## port

port って打ったら、 port 使ってる人が出て欲しい。

引数に渡したポートを開いてるのが誰(PID)か知るためのコマンド。
Port がすでに開いてるエラーにあったとき便利。


## timeset()

時間がずれた時に一瞬で治すコマンド。

立ち上げたばかりのマシンや、時間がずれたマシンで、 ntp の同期を待つ前にとにかく合わせたい時がある。
便利なことに unixtime を返してくれる URL があるので、それを `date` に食わせている。


## alc()

英単語を渡すと http://alc.co.jp で検索して結果を返すコマンド。


# zsh のエイリアス

## B

末尾につけると "1>/dev/null 2>/dev/null &" してバックグラウンドにしてくれる。

先に紹介した http コマンドは、これをつけて上げっぱなしにしておくことが多い。

```
$ http B
```

## C

末尾につけると "2>&1 | color" して、なんでも雑に色付けする。

先に紹介した color を使っている。


## U

末尾に付けると、 "| sort | uniq -c | sort -nr" でよくあるカウントをする。

```
$ access.log | cut -f4,7 | grep 404 U
```


## V

末尾に付けると、標準出力をそのまま vim で開く

```
$ access.log | cut -f4,7 | grep 404 V
```
