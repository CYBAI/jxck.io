# [webp][image][performance] 画像最適化戦略 WebP 編

## Intro

本サイトの PNG/JPEG で提供している画像については、よりサイズが小さくなりやすい WebP でも同様のものを提供し、対応ブラウザに配布するよう対応した。フォーマットを出し分けるため `<picture>` 要素にて対応した。


## WebP

従来の Web において、画像は用途毎に PNG/JPEG/GIF などを使い分けていた。
一般的には以下のような使い分けが行われている。


- PNG: 主に UI アイコンなど色変化の少ない画像
- JEPG: 主に写真など色変化が多い画像
- GIF: 主に GIF アニメメーション


WebP は Google が開発した画像フォーマットであり、これら三つの用途全てに適した上でさらに小さいサイズに圧縮できる可能性が高い。

現状まだ対応するブラウザは限られているが、対応しているのであれば WebP で配布するのが望ましい場合が多い。

## WebP

PNG, JPEG 両方の用途で代替として検討できる。

このフォーマットを使うことで、画質を犠牲にせずかなりのサイズ削減が期待できる。

WebP アニメーションを使えば、 GIF アニメよりも色数が多く綺麗なアニメーションを作ることができる。

WebP は WebM の1フレームが基本なため、つまり WebP アニメーションは簡易 WebM と言っても良い。スクリーンシェアなどに使用しやすいだろう。

しかし対応してないブラウザのためには代替として PNG, JPEG などにフォールバックできるように、後述の srcset で選択肢として提示し、ブラウザに選ばせている。


### WebP 対応

これまでは写真=JPEG, アイコン=PNG, アニメ=GIF といった使い分けがなされていたが、もし対応しているのであれば、これら全て WebP に集約可能であり、その方がサイズ的に有利な場合が多い。

しかし、 [WebP の対応はまだまだ限定的](http://caniuse.com/#feat=webp) であるため、過去の記事では UA を元にしたサーバ側での出し分けの方法などが紹介されている。

しかし、 UA での分岐は避けるべきパターンの一つであり、なによりスケールしにくい。

一方、 HTML の `<picture>` や `srcset` を用いることで、ブラウザ自体にそれを判断させることができるため、こちらの方法が望ましい。
( [picture](http://caniuse.com/#search=picture), [srcset](http://caniuse.com/#search=srcset) に対応していない古いブラウザは、そもそも WebP に対応していない)


## WebP 変換

本サイトの画像は、 Mac で取得したスクリーンショットか cacoo で作成した図が中心である。
いずれも WebP での書き出しには対応していないため、現状は PNG/JPEG を WebP に変換することで、 WebP 画像を生成することになる。

WebP への変換ツールはいくつかあるが、

## lossy png と webp


