# [webp][image][performance] 画像最適化戦略 WebP 編

## Intro

本サイトの PNG/JPEG で提供している画像については、よりサイズが小さくなりやすい WebP でも同様のものを提供し、対応ブラウザに配布するよう対応した。フォーマットを出し分けるため `<picture>` 要素にて対応した。


## WebP

従来の Web において、画像は用途毎に PNG/JPEG/GIF などを使い分けていた。
一般的には以下のような使い分けが行われている。


- PNG: 主に UI アイコンなど色変化の少ない画像
- JEPG: 主に写真など色変化が多い画像
- GIF: 主に GIF アニメメーション


WebP は Google が開発した画像フォーマットであり、これら三つの用途全てに適した上で、さらに小さいサイズに圧縮できる場合が多い。

また、 WebP は動画フォーマットである WebM の 1 フレームに相当するため、 WebP アニメーションは簡易 WebM と言っても良い。
GIF アニメよりも、色数が多く綺麗なアニメーションを小さいサイズで作ることができるため、技術ブログで言えばデモのスクリーンアニメなどに使用しやすいだろう。

現状まだ対応するブラウザは限られているが、対応しているのであれば WebP で配布するのが望ましい場合が多い。


## WebP 変換

本サイトの画像は、 Mac で取得したスクリーンショットか cacoo で作成した図が中心である。
いずれも WebP での書き出しには対応していないため、現状は PNG/JPEG を WebP に変換することで、 WebP 画像を生成することになる。

WebP への変換ツールはいくつかあるが、


## WebP の指定

しかし、 [WebP の対応はまだまだ限定的](http://caniuse.com/#feat=webp) であるため、非対応ブラウザには PNG/JPEG/GIF などを送る必要がある。

この方法として、 JS を用いる方法や、 UA を用いたサーバサイドでの分岐などが紹介される場合がある。
しかし、 UA での分岐は避けるべきパターンの一つであり、なによりスケールしにくい。

一方、 HTML の `<picture>` を用いることで、ブラウザ自体にそれを判断させることができるため、こちらの方法が望ましい。


## `<picture>` での指定

`<picture>` の `type` を用いることでフォーマットの指定も可能である。

画像の指定を以下のように指定することで、対応ブラウザが自ら WebP をリクエストするようになり、 WebP や `<picture>` に対応していない場合は `<img>` に指定した画像にフォールバックする。


```html
<picture>
  <source type=image/webp srcset=hero-image.webp>
  <img src=hero-image.png alt="hero image">
</picture>
```

`<picture>` に対応していないブラウザでは、 `<img>` に指定した画像にフォールバックされるため、ここには PNG を指定する。

この場合、 WebP に対応しているが `<picture>` に対応していないブラウザが気になるところだが、現状 [picture](http://caniuse.com/#search=picture) に対応し [webp](http://caniuse.com/#search=webp) に対応していないブラウザは無い。

また、この指定は現在 WebP に対応していないブラウザが将来対応した場合に、サイトに何も手を加える必要がない。

UA で分岐をする方法より、将来のメンテナンスを踏まえても好ましい方法と言える。


|    format |   size |
|:----------|-------:|
| jxck.png  |   3.8K |
| jxck.webp |   1.8K |
| jxck.svg  |   291B |
