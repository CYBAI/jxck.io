# [performance][cache][http] Cache-Control: immutable によるリロード時のキャッシュ最適化

## Intro

ブラウザはリロード時に、 Conditional Get によってキャッシュの Validate (有効性の問い合わせ)を行う。

Cache-Control Extension として提案されている immutable オプションは、キャッシュが max-age 内であればリロード時もキャッシュヒットさせる拡張である。

このヘッダの効果と、本サイトへの適用について記す。


## Cache-Control

Cache-Control に max-age を指定することで、ブラウザにリソースをキャッシュさせることができる。

このキャッシュは max-age の期間内はフレッシュとみなされ、フレッシュであればサーバへの問い合わせなく再利用される。

サーバへの問い合わせが無いため、事実上最速のリソース取得となる。


## Reload

しかし、現在のブラウザではフレッシュなキャッシュがそのままヒットするのは、ナビゲート(遷移)時のみである。

リロードやスパーリロードの場合は、 max-age 内のキャッシュであっても、扱いが変わる。


- ナビゲート(link, redirect): フレッシュなキャッシュはヒットする
- リロード(F5, cmd+r etc): フレッシュであっても無視し、 Conditional Get を行う
- スーパーリロード(shift + reload etc): フレッシュあっても無視し、 Get を行う。


ブラウザがリロードを行った場合に挙動については、以下に詳細がまとまっている。

- https://docs.google.com/document/d/1vwx8WiUASKyC2I-j2smNhaJaQQhcWREh7PC3HiIAQCo/edit


## Immutable Extension

Cache-Control Immutable Extension は、 Cache-Control の拡張の一つである。

以下のように指定することで、キャッシュを immutable と指定することができ、ブラウザはキャッシュがフレッシュであればリロード時でもヒットさせるようになる。


```
Cache-Control: max-age=10000, immutable
```

これによって、なんらかの原因でユーザがリロードを行う場面においても、無駄なリクエストを防ぐことができる。

特に、画像、映像、フォントといったサイズが大きくも表示において重要なリソースについては、キャッシュの再利用がサーバの負荷という面でも、 UX の面でも有利に働く。


## リロードというユーザ操作

そもそも、ユーザがリロードを行う場合とはどういう場合だろうか。

よく F5 連打といえば、同一 URI 上でのリソースの更新をいち早く知りたい場合に使われる。

それ以外には、なんらかのバグによって画面の表示が崩れたりした場合に、ユーザが復旧のために取れる手段としても使われているだろう。

古いサイトには、なんらかの場面でユーザに「リロードしてください」と依頼するものもあったと思う。

筆者は、本来ユーザが明示的にリロードを発生させること自体が、サイトの作りとして問題をはらんでいる場合があると考えている。

今では更新を通知して導く方法もたくさんある、崩れるのは明らかにバグだ、ましてやユーザにリロードを行わせる設計は間違っていると言える。


それでも、ユーザの置かれたネットワークのプロキシや、ブラウザ拡張や、その他ユーザサイドの問題として、ユーザがリロードを行う場合はあるだろう。
この場合、ユーザがリロードを行うのは、リソースの状態をサーバに問い合わせ、フレッシュに保ちたいという意図が考えられる。

もし、多くのリソースを immutable に指定すれば、キャッシュはヒットしても、サーバへの問い合わせ(スーパーリロード以外)は行われなくなる。

結論から言うと、例え max-age が付与できる設計であるとしても、 immutable を指定するのは慎重であるべきではないかと考える。


## 本サイトへの適用

このサイトでは Web Font を配布しているが、その内容は変更頻度が非常に低い。

また、サイト上で動画の次にサイズの大きいリソースである。

しかし、表示時に Web Font の問い合わせが発生してしまうと、画面の表示が一瞬システムフォントになるか、フォントが表示されない状態に見える可能性がある。
302 が返ってくるとしても、 1RTT 発生してしまうことに変わりは無い。

したがって、リロード時だとしてもそのままローカルキャッシュがヒットし、表示に利用される方が望ましい。

また、 Favicon は多くのリクエストで暗黙的に発生しがちだが、こちらもおおよそ変更の予定が無い。

こちらも immutable 指定が可能であると判断した。
